---
title: "DAM AT1 Part A Linear Regression, by Alex Brooks"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#note to self: correct working directory is setwd("/Users/alex/Projects/DAMAssignment1")
#load libraries 
library(modelr)
library(readr)
library(ggplot2)
library(dplyr)
```

### AT1 Spring 2018: Part A
## Data Cleaning and Exploratory Data Analysis on "transactions.csv" dataset
Read in the data check the structure to see if it needs cleaning.
```{r}
#import dataset 
transactions = read.csv("transactions.csv", header = T)
#check data structures match the supplied data dictionary
str(transactions)
#need to change date from 'Factor' to Date format to clean the data
```

## 1. a. Cleaning the data

The values in the date column should be Date format, not Factor, and customer_id needs to be String or Character, not Factor.  

```{r}
#Clean data columns into an understandable format which matches the data dictionary
transactions$date = as.Date(transactions$date, format = "%d/%m/%y")
transactions$customer_id = as.character(transactions$customer_id, format = "")
#View the data structure and eyeball the data file to confirm
str(transactions)
View(transactions)
```
##EDA: create histograms of industry and location variables
```{r}
par(mfrow=c(1,2))
hist(transactions$industry, main = "Histogram of number of transactions by Industry", xlab="Industry", ylab="Number of transactions", xlim = c(0,10), ylim=c(0,50000), las=0)
hist(transactions$location, main = "Histogram of number of transactions by Location", xlab="Location", ylab="Number of transactions", xlim = c(0,10), ylim=c(0,50000), las=0)
```
# What's the EDA revealing?
It looks like locations one and two account for the greatest majority or volume of monthly transactions and there's something about industry code 6 that's very distinct from the other industry categories.

```{r}
#let's visualise a scatterplot 
ggplot(transactions, aes(x=industry, y=monthly_amount, color=location)) + 
  geom_point() + geom_smooth()
```

```{r}
# Let's mutate the dataset to create a new column called 'monthly_amount_above_mean' to explore higher value monthly amounts
transactions <- transactions %>%
  # creating a new variable to classify transaction column
  mutate(monthly_amount_above_mean = ifelse(monthly_amount > mean(monthly_amount), TRUE, FALSE))
# plot a bar chart by monthly amounts by date  
qplot(x = date, fill = monthly_amount_above_mean, data = transactions, geom = "bar", main = "Number of transactions by month, showing proportion above the mean")

```

This reveals most monthly amounts are below the mean and the monthly amounts grow steadily rather than steeply. Let's now look at it by industry and location, too

```{r}
# plot a bar chart by monthly amounts by location
qplot(x = location, fill = monthly_amount_above_mean, data = transactions, geom = "bar", main = "Number of transactions by location, showing proportion above the mean")
```
#So what about by industry?

```{r}
# plot a bar chart by monthly amounts by industry
qplot(x = industry, fill = monthly_amount_above_mean, data = transactions, geom = "bar", main = "Number of transactions by industry, showing proportion above the mean")
```
#1. b. Description of 2 insights from EDA
##Some insights for the sales manager
Location 1 and 2 have the highest volumes of monthly_amounts, as well as the most above-average monthly amounts.

Industry 6 has the least amount of monthly_amounts, which is likely to be sales volume data or something similar. So while industry 6 is a low volume industry, they have above average sales amounts. 

Industries 3, 5 and 9 look to have a greater proportion of their transactions above the mean average monthly amount

### Basic model fitting
## 2. a. Creating the model
# i. Let's aggregate the data and see if we can get more insights
```{r}
# Aggregate the data, grouping by date, industry and location, and calculating the mean monthly_amount
aggregated_transactions <- transactions %>%
  group_by(date, industry, location) %>%
  summarize(monthly_amount = mean(monthly_amount, na.rm = TRUE))

# Let's also create a column for the month number and another one for year number
aggregated_transactions <- aggregated_transactions %>%
  mutate(month_number = format(as.Date(date), "%m")) %>%
  mutate(year_number = format(as.Date(date), "%Y"))

aggregated_transactions$month_number <- as.integer(aggregated_transactions$month_number)
aggregated_transactions$year_number <- as.integer(aggregated_transactions$year_number)

#transform(aggregated_transactions, month_number = as.integer(month_number), year_number = as.integer(year_number))

# View the data
aggregated_transactions
```
## 2. a. ii. Create a line plot of the variable monthly_amount for industry = 1 and location = 1
```{r}
#Create a line plot of the variable monthly_amount, for industry = 1 and location = 1

ggplot(data=filter(aggregated_transactions, industry == 1 & location == 1), aes(x=date, y=monthly_amount, group=1)) + geom_line(color="red") + geom_point() + labs(title="Line plot of mean monthly amount for Industry = 1 and Location = 1", x="Date", y="Mean Monthly Amount")
```
##2. a. iii) i) Trying to train the linear regression model with monthly_amount as the target
```{r}
#Monthly_amount (or more specifically mean monthly amount) is the target variable whose values are to be modeled/predicted by other variables. Can't use location or industry as a predictor variable, so by deduction the only possible predictors is month number and/or date.
dataSet <- filter(aggregated_transactions, industry == 1 & location == 1)
#take a look at the filtered dataSet
str(dataSet)

# Run linear model with testing and training sets, with monthly_amount as target and month number as the predictor
#Training set is every month other than month 12
trainingSet <- filter(dataSet, month_number != "12")
#Testing set is data from month 12 only
testingSet <- filter(dataSet, month_number == "12")
```
Now for the tests of each one  
```{r}
month_number.lm <- lm(monthly_amount~month_number, data=trainingSet)
  # plot the regression diagnostics.  Note the red line on two left plots is not straight
summary(month_number.lm)
```
Now to plot month_number
```{r}
plot(month_number.lm)
```

```{r}
#FIXTHISpredictedData <- predict(month_number.lm, testingSet)
#FIX BROKEN BITrmse(dataSet$monthly_amount, predictedData)
```

# Run linear model with monthly_amount as target and date as the predictor
```{r}
date.lm <- lm(monthly_amount~date, data=trainingSet)
  # plot the regression diagnostics.  Note the red line on two left plots is not straight
summary(date.lm)
```
Now to plot date
```{r}
plot(date.lm)
```

# Run linear model with monthly_amount as target and month number + date as the predictor
```{r}
month_number_and_date.lm <- lm(monthly_amount~month_number + date, data=trainingSet)
  # plot the regression diagnostics.  Note the red line on two left plots is not straight
summary(month_number_and_date.lm)
```
# Plot month_number + date
```{r}
plot(month_number_and_date.lm)
```

# Run linear model with monthly_amount as target and date + month_number as the predictor
```{r}
date_and_month_number.lm <- lm(monthly_amount~date + month_number, data=trainingSet)
  # plot the regression diagnostics.  Note the red line on two left plots is not straight
summary(date_and_month_number.lm)
```
#Now to plot date + month_number
```{r}
plot(date_and_month_number.lm)
```
##2. a. iii) ii) How to split test and train sets
Alex to write about how it was done in this model

##2. a. iv) Create a prediction for monthly_amount in December 2016
let me work this out
##2. b. Describe the model
## 2. b. i) How well does the model fit the data it is trained on in a statistical sense
Alex to describe and define an appropriate quantative measure and justify it
```{r}
#TO DO
```
## 2. b. ii) How well does the model predict out of sample
Alex to define and describe an appropriate quantitative measure and justify the choice of measure
```{r}
#TO DO
```
## 2. b. iii) Which features did you end up using in your final model?
Alex to justify choice of features, and thus feature selection method
```{r}
#TO DO
```
## 3. Advanced model fitting
Describe what that means
## 3. a. Apply the modelling process you built for industry 1 and location 1 to all industries and locations programmatically
Describe what that means
```{r}
#TO DO
```
## 3. a. Apply the modelling process you built for industry 1 and location 1 to all industries and locations programmatically
Describe what that means
```{r}
#TO DO
```
## 3. b. Calculate your evaluation measure for teh training data and your testing data for all models
Describe what that means
## 3. b. Identify the two worst industries and two locations for which your method performs worst.
Describe what that means
## 4. Reporting
Describe what that means
## 4. a. Report for sales manager following CRISP-DM methodology
Describe what that means by making sure there is enough technical detail to withstand QA and technical scrutiny while explaining it for a business audience
## 4. b. APPENDIX
Put your predictions for December 2016 as an appendix - and reference predictions, the actual and the difference in your CRISP-DM Report
## REFERENCES